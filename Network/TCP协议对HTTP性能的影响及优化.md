# TCP协议对HTTP性能的影响及优化

## TCP的时延
1、tcp连接时的握手时延；
2、tcp慢启动拥塞控制；
3、数据聚集的Nagle算法；
4、用于捎带确认的tcp延迟确认算法；
5、TIME_WAIT累积（延迟确认）和端口耗尽。

##　优化
1. 小的HTTP事务，可能在TCP的建立上话费50%，或更多的时间，通常HTTP事务都不会交换太多数据。
可以重用现有连接，来减少建立连接的时延所造成的影响。

2. TCP慢启动限制了一个TCP端点在任意时刻可以传输的分组数，用于防止因特网的突然过载和阻塞。
HTTP有大量数据要发送时，不可能一次性全部将分组发送出去，先发送一个分组，收到确认后，可以发送两个分组，每个分组都被确认，就可以发送四个分组。
所以新连接的传输速度会比已经传输过一定量数据的已调谐连接慢一些。可以重用现有连接——HTTP持久连接。

3. 每个TCP段都包含至少40个字节的标记和首部，如果发送大量包含少量数据的分组，网络的性能就会严重下降。
Nagle算法在发送数据之前尽可能将大量数据绑定在一起，鼓励发送全尺寸数据，带来的问题是：
小的HTTP报文无法填满一个分组时，就会因为等待那些不可能到来的数据而产生时延，Nagle算法阻止数据的发送，直到有确认分组抵达，但确认分组自身会被延迟确认算法延迟100-200ms

HTTP应用程序可以设置TCP_NODELAY禁用Nagle算法，提高性能，但前提是要确保会想TCP写入大块的数据，这样就不会产生一堆小的分组。

4. 每个段的接收者收到完好的段时，都会会送一个小的确认分组，如果在制定的窗口时间内没有收到确认就会重发分组。
由于确认报文很小，可以与输出的数组分组结合在一起，进行捎带确认，可以更有效的确认网络。
延迟确认：为了增加确认报文找到同向传输数据的可能性，TCP栈会在特定的窗口时间内，将确认放在缓存中，以寻找能够携带的分组，如果在那个时间段内没有输出数据，就将确认放在单独的分组中传送。

HTTP具有双峰特征的请求-应答行为降低了捎带信息的可能。希望有相反方向的回传分组的时候，偏偏没有那么多，所以延迟算法引入了相当大的时延，可以调整或禁止延迟确认算法。

5. 确保在2MSL时间内不会创建具有相同地址和端口号的新连接。TIME_WAIT状态很多也没什么大问题，但在性能基准环境下就可能会成为一个问题,可能因为它占用了系统过多的端口，导致后续的请求无法获取端口而造成障碍。

更多可以参考[TIME_WAIT与端口耗尽](http://www.cnblogs.com/tiantiandas/p/time_wait.html)


